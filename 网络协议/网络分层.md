# 网络分层

[网络模型到底是七层，五层，还是四层？](https://zhuanlan.zhihu.com/p/73807507)

​		

## 为什么网络需要分层? 

**因为复杂的程序都要分层. 这是程序设计的要求**

互联网将实现分为若干层, 每一层都有自己的功能(各司其职), 就像建筑物一样每一层都靠下层支持

​		

## 网络模型分多少层

网络分层有三种方式

1.  OSI七层协议
2.  **TCP/IP四层协议**
3.  基于OIS和TCP/IP的五层协议(仅存在与理论学习. 实际应用不存在)

现在普及的虽然是TCP/IP协议, 但OSI协议还是建议学习(毕竟面试会问...)

>   网上说OSI输给TCP/IP的原因是标准形成慢, OSI开会的时间TCP/IP都迭代几个版本了. 而且OSI偏向理论, 实现比较复杂

![各个协议分层以及对应](%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82.assets/image-20210401214710795.png)



## 关于分层的比喻

网络协议分层的本质是将复杂的网络通讯简单化. 

因此无论那个模型, 对应的层都要针对数据做一些**封装或者解析**. 所以所有不能表示出层层封装含义的比喻，都是不恰当的

这里看到一个比较合适的比喻是

**通信协议就像没有天桥的双子楼，要从A座的5层到达B座5层就得先下楼梯再上楼梯(中途每一层楼都要打卡/封装)**

如下图所示:

![网络协议-2主机通讯](%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82.assets/v2-ec48b96b492a4f473a68ed47a721d551_1440w.jpg)

同时有一点需要注意. 

**只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没下层。**

​		



## 物理层

**物理层为数据端设备提供传送数据通路、传输数据**

由网线. 网卡. 集线器等实际存在的硬件构成

常用的协议分为2类

1.  点对点通信线路物理层协议
2.  广播通信线路物理层协议

其中广播通讯线路又分为: 有线通信线路(网线)和无线通信线路(WIFI).

常见的物理层设备有: 光纤, 集线器, 串口, 并口



## 数据链路层

在我看来. **数据链路层主要是封装一个MAC地址. 由这个MAC地址可以从局域网中找到对应机器**

官方说法: 最基本服务是将物理层提供的可能出错的物理连接改造成逻辑上无差错的数据链路(**纠错**), 并对物理层的原始数据进行数据封装(**封装**)

数据链路层也称为MAC层.MAC全称Medium Access Control，即**媒体访问控制**

常见的数据链路层设备有: 网卡, 交换机, 桥接器

​		

下图就是一个经过数据链路层封装的数据

![数据链路层封装](%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82.assets/8072e4885b0cbc6cb5384ea84d487e41.jpg)

### 目标MAC如何获取

1.  从本地缓存中获取. 
2.  本地缓存中不存在则先向目标局域网发送一个ARP请求

下图就是一个完整的ARP请求(*ARP请求是已知IP求MAC*)

![ARP请求](%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82.assets/1f7cfe6046c5df606cfbb6bb6c7f899b.jpg)

### CRC作用

循环冗余检测。通过 XOR 异或的算法，来计算整个包是否在发送的过程中出现了错误

​		

## 网络层

在我看来: **网络层主要为数据包封装一个IP, 由这个IP可以帮助数据包在局域网内的流传和局域网到局域网的流转**

官方说法: 负责在不同局域网之间转发数据包, 但不负责数据包的可靠性(是否达到和接受顺序)

常见的网络层设备有: 路由器, 三层交换机

主要协议有: 

*   IP协议

​		

举个简单的例子

MAC地址和门牌号相似, 如`青华路128号`. 但武汉市和广州市可能都有这个`青华路128号`, 此时就要一个全局唯一的名称前缀标识这个`青华路128号`是武汉的还是广州的. 这里的武汉和广州和IP对应

**MAC定义了本地局域网的传输行为, IP定义了网络端到端的传输行为**

>   不太形象, 因为局域网内部通讯也会有IP. 

​		

下图是一个进过封装的数据包(主要封装了2个IP头进去)

![网络层封装](%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82.assets/825e54560a6de08a32e4cab4e0f59f65.jpg)



### 一个通过互联网进行数据交换的例子

这里本来有一个图, 说明了数据在服务器和路由间流转的IP转换...然而...画不出来...因为不太懂NAT和NAPT协议...

​		

## 传输层

**运输层为应用进程之间提供端到端的逻辑通信**

传输层主要有2个协议

1.  TCP
2.  UDP

### TCP

TCP协议面向连接, 即通讯前需要经过三次握手, 断开时需要四次挥手

TCP有如下特点:

1.  是一个有状态服务, 保证传输的数据无差错, 不丢失, 不重复且顺序到达
2.  拥有流量控制(在规定速度下发包)和拥堵控制(网络拥堵时发慢些)

基于TCP协议的网络层封装

![基于TCP协议的网络层封装](%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82.assets/642947c94d6682a042ad981bfba39fbf.jpg)

### 三次握手

### 四次挥手

### 累计应答/累计确认

因为TCP协议是一个可靠协议. 

为保证顺序性, 每一个包都有ID, 在建立连接的时候会商定起始ID, 然后按照ID一个个发送

为了保证不丢包对于发送的包都需要应答. 但不是一个个应答的,而是会应答某个ID, 表示之前的包都收到了

这种方式被称为累计应答或者累计确认

​		

### 流量控制

在TCP里接受端会给发送端报一个窗口大小, 叫Advertised window. 

### UDP

UDP协议面向无连接, 即通讯前不需要建立连接

UDP有如下特点:

1.  不保证数据包丢失, 不保证顺序到达
2.  不需要一对一建立连接, 可以在基础上承载广播或者多播协议
3.  处理速度快延迟低

基于UDP协议的应用

1.  流媒体协议(直播).
2.  实时游戏. 
3.  物联网

基于UDP协议的网络层封装

![基于UDP协议的网络层封装](%E7%BD%91%E7%BB%9C%E5%88%86%E5%B1%82.assets/2c9a109f3be308dea901004a5a3b4c84.jpg)

