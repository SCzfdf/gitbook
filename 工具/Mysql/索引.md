# 索引

官方定义索引是帮助MySQL高效获取数据的**数据结构**, 它类似字典



## 索引的设计思考

![image-20220613150027451](%E7%B4%A2%E5%BC%95.assets/image-20220613150027451.png)

> 这个图是一个抽象结构图, 并不是真正的物理存储结构

以上图为例. 真实的数据是存放在磁盘中的, 如果没有索引需要从大批量数据中检索某一条数据的话就只能遍历

但有了索引只需要从索引中找到对应的地址即可



## 索引的数据结构设计

从上面得知, 索引的主要功能时快速检索. 也就是说索引在搜索的时间复杂度上要低(比对次数越少越好).

因为Mysql管理的数据量可能很大, 因此不能把全部数据, 乃至全部索引数据都加载进内存

所以只能一次次读取硬盘数据来对比查找符合的索引数据. 因此算法的时间复杂度至关重要

​		

符合的数据结构有很多, 最常见的有

* [平衡二叉树](../../算法/数据结构/树/AVL树.md)
* [红黑树](../../算法/数据结构/树/红黑树.md)
* [B树](../../算法/数据结构/树/B树.md)
* [B+树](../../算法/数据结构/树/B+树.md)

其中平衡二叉树和红黑树会随着数据量增多, 树的高度也会逐渐增高(对比次数逐渐增多). 不太适合做索引

而B+树中链表的特性能做范围查询因此选择B+树做底层的数据结构.





## 聚簇索引与非聚簇索引

[聚簇索引参考](https://blog.csdn.net/taoqilin/article/details/121230649)

聚簇索引(聚集索引), 就是在索引对应的B+树中叶子节点存储的是**真实的数据**

聚簇索引只有一个, 优先级入下:

1. 主键索引
2. 非空索引
3. 隐式定义一个索引担任聚簇索引

> 这也是Mysql建议每个表都有一个主键的原因

​		

非聚簇索引(辅助索引)对应的B+树中子节点存储的是**id的值**

辅助索引访问数据总是需要二次查找

> 上述是InnoDB的. 对于MyISMA没有聚簇一说, 索引存储的都是磁盘地址.
>
> 所以从硬盘的角度看
>
> InnoDB索引和数据文件是放在一起的
>
> MyISMA索引和数据文件是分开的



## 索引优化

[mysql-索引使用-列的散列度-01](https://www.jianshu.com/p/903bb6ad827d)

1. 离散度

   列重复的值越少, 离散度越高. 应该尽量在离散度高的列做索引

2. 联合索引最左匹配

   联合索引左边的列应该挑选离散度更高的

   并且联合索引在搜索时**只用右边**的列进行搜索是不会走索引查询的

   此时的索引类似下图: 

   ![image-20220614134844744](%E7%B4%A2%E5%BC%95.assets/image-20220614134844744.png)

3. 覆盖索引

   如果需要查询的数据能从索引中获取就不用再查询一次聚簇索引获取数据. 

   如: `select name, phone from user where name = "jack"`. 

   name和phone是一个联合索引, 那么只返回name和phone就不用再查询一次聚簇索引. 因为联合索引对应的B+树已经有了对应的数据

4. 索引下推

   [五分钟搞懂MySQL索引下推](https://baijiahao.baidu.com/s?id=1716515482593299829&wfr=spider&for=pc)

   索引下推(Index Condition Pushdown, 简称ICP 5.6的功能). 简单来说就是将Service层做得数据筛选下推到储存引擎去做. 目的是为了减少回表次数.

   ```sql
   # 查看状态, 默认是开启的
   select @@optimizer_switch
   
   # 切换状态
   set ="index_condition_pushdown=off";
   set ="index_condition_pushdown=on";
   ```



## 索引失效

以下情况可能会导致查询时全表扫描

1. 索引列使用**函数**或者**隐式转换**

   ```sql
   # 隐式转换, name是字符串类型. 会导致全表扫描
   EXPLAIN select * from t_user where user_name = 555;
   EXPLAIN select * from t_user where user_name = "555"
   ```

2. like查询使用前通配符

   对于B+树来说, 知道开头也可以进行搜索, 搜索完之后通过链表即可知道下一个. 

   ```sql
   # 下面情况尽量避免, 因为不走索引
   EXPLAIN select * from t_user where user_name like  '%张';
   ```

   

## InnoDB一棵B+树可以存放多少行数据

[MySQL：InnoDB一棵B+树可以存放多少行数据？](https://juejin.cn/post/6904293886626103309)

[mysql b+树能存多少条数据？b+树每层有多少分支？](https://blog.csdn.net/csdnlijingran/article/details/102309593)

[一颗高度为3的B+树到底能存多少数据呢](https://juejin.cn/post/6973647815473889311)


