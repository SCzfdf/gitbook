# 顺序消费

[阿里RocketMQ如何解决消息的顺序&重复两大硬伤？](https://dbaplus.cn/news-73-1123-1.html)

[重复消费、顺序消费、分布式事务](https://github.com/AobingJava/JavaFamily/blob/master/docs/mq/%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E3%80%81%E9%A1%BA%E5%BA%8F%E6%B6%88%E8%B4%B9%E3%80%81%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1.md)

[顺序消费模式和迅速消息发送模式](https://www.cnblogs.com/huigelaile/p/10928984.html)

[分布式消息队列：如何保证消息的顺序性](https://juejin.im/post/5c9b1c155188251d806727b2)



**世界上解决一个计算机问题最简单的方法：“恰好”不需要解决它！——沈询**

>   在参考上看到的, 第一个想法是, 能不顺序就不顺序. 确保幂等性方便多了~

​		

>   业务场景: 电商, 订单生成 -> 付款 -> 发货

## 顺序投递

>顺序消费的前提是消息顺序投递, 下面都在顺序成功投递的前提下
>
>MQ只确保顺序投递即可, 顺序消费是消费者和补偿机制需要考虑的

### 单队列 顺序发送

因为队列是先进先出, 在使用一个队列消费的前提下, 只要确保单机顺序发送即可做到顺序投递

开启confirm 确认消息后

在server成功收到mq的确认后才发送下一条消息, 直到消息全部发送完毕

​		

### 多队列 队列选择发送

>   其实搞不懂这个, 这个实在<重复消费、顺序消费、分布式事务> 里看到的
>
>   你都使用多个队列了, 不能一个消费完成在发另一条消息吗(这样耦合了)
>
>   尽管是保证顺序了, 可是都是一个方法入口的这样选择还有意义吗?

​		

------

​		

## 顺序消费

### 单机消费

使用单独的消费者独占队列, 这样在消息顺序投递的前提下肯定能确保消费. 

不过会有很多问题, 不推荐

​		

### 使用work 线程

把异步的流程(订单生成 -> 付款 -> 发货) 整合到一条消息

消费者接收到消息就顺序处理, 处理完再拉取消息

>   MQ就只是用作异步消息发送, 只用于削峰
>
>   好处是代码改动不大, 坏处是业务代码还是耦合的
>
>   不过比单机消费好的是可以使用集群

​		

### 重回队列

正常消费, 不过消费之前要检查消息的状态(查消息表或者redis)

如果消息还轮不到这次流程就是把消息重新放回队列中

>   这个要做好补偿, 计算重回的次数, 估算各个流程的队列时间加机器等(不然流程后面执行的那个队列执行时间很少的情况下, 那个队列基本不会积压, 重回队列n次就失败了) 比较麻烦

​		

### 消息通知

如果是对流程有严格要求的业务

可以把一个消息发往一个服务A(下单), 

服务A处理完后: 

	1. 由A服务发送到服务B(付款). 
	2. 由A服务通知总服务自身业务已执行完成, 可以执行下一步流程

>   2 比1好, 解耦, 可是麻烦= =

